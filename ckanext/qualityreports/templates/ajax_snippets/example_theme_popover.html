{# The contents for a dataset popover.

   id - the id of the dataset
   num_resources - the dataset's number of resources
   license_title - the dataset's license title

#}
<div class="context-info">
  <div class="nums">
    <h5>
      WORK IN PROGRESS<br>
      Data transformation to RDF status:
    </h5>
    <p id="qualityreports_status"></p>
    <br>
    <span style="word-break: keep-all;">
      If you want to, you can start the transformation with the following button.
      Please note that it can take a while. Refresh this page if it takes too long to see the new status.
    </span>
    <br>
    <button id="qualityreports_start"
      onclick="startExecution()" >
      Start
    </button>
  </div>
  <br>
  <div>
    <dl>
      <dt>Graph</dt>
      <dd id="qualityreports_graph"></dd>
    </dl>
  </div>
  <br>
  <div class="license">
    <dl>
      <dt>License</dt>
      <dd>{{ license_title }}</dd>
    </dl>
  </div>

  <div class="clearfix"></div>

</div>
<script>
// Get and clean the package data
let pgk = '{{ extras }}'.replaceAll("&#39;", "\"")
  .replaceAll("u\"", "\"")
  .replaceAll("None,", "null,")
  .replaceAll("True,", "true,")
  .replaceAll("False,", "false,");
console.log(pgk);
console.log(JSON.parse(pgk));

// prepare the extra information
var extras = JSON.parse(pgk);
let nomad_id = "dummy";
extras.forEach((e) => {
  if (e.key === "Website") {
    var splits = e.value.split("/");
    nomad_id = splits[splits.length-2] + "/" + splits[splits.length-1];
  }
  });
console.log(nomad_id);

// create the request for the status
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    var json = JSON.parse(this.responseText);
    console.log(json);
    $("#qualityreports_status").html(json.status);
    if (json.targetGraph) {
      $("#qualityreports_graph").html(json.targetGraph);
    }
  }
};
// TODO read if NOMAD or DSMS
function getServiceURL() {
  let port = "";
  let prefix = "qualityreports.";
  if (location.host === "localhost") {
    port = ":8080";
    prefix = "";
  }
  return location.protocol+"//"+prefix+location.host+port;
}
xhr.open("GET", getServiceURL()+"/mapping?id="+nomad_id+"&repository=NOMAD", true);
xhr.send();


/////////////////
// creating the request for starting the execution
function startExecution() {
  $("#qualityreports_start").prop('disabled', true);
  $("#qualityreports_status").html("RUNNING");
  $("#qualityreports_graph").html("");

  var xhr2 = new XMLHttpRequest();
  xhr2.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var json = JSON.parse(this.responseText);
      console.log(json);
      $("#qualityreports_status").html(json.status);
      $("#qualityreports_start").prop('disabled', false);
      if (json.targetGraph) {
        $("#qualityreports_graph").html(json.targetGraph);
      }
    }
    else
      console.log(this);
  };
  xhr2.open("GET", getServiceURL()+"/startExecution?id="+nomad_id+"&repository=NOMAD", true);
  xhr2.send();
}

</script>